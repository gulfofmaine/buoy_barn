# version: "3.7"

# services:
db:
  image: mdillon/postgis:10-alpine
  restart: always
  env_file:
    - ./docker-data/secret.env
  environment:
    PGDATA: /var/lib/postgresql/data/PGDATA
  volumes:
    - ./docker-data/postgres:/var/lib/postgresql/data

cache:
  image: redis:5.0.3-alpine
  restart: always

web:
  build: ./app
  # command: bash -c "./utils/wait-for-it.sh db:5432 &&  python manage.py runserver 0:8080"
  # command: "uwsgi --http :8080 --wsgi-file buoy_barn/wsgi.py  --master --processes 4 --threads 2"
  command: "uwsgi --module=buoy_barn.wsgi:application --master --pidfile=/tmp/project-master.pid --http :8080 --uid=1000 --gid=2000 --max-requests=5000 --vacuum --processes 4"
  restart: always
  volumes:
    - ./app:/app
    - ./.prospector.yaml:/app/.prospector.yaml
    - ./docker-data/django-static:/static
  ports:
    - "8080:8080"
  environment:
    DJANGO_MANAGEPY_COLLECTSTATIC: "on"
  env_file:
    - ./docker-data/secret.env
  links:
    - db
    - cache
